# å·¥å…·è°ƒç”¨åˆ é™¤é—®é¢˜ä¿®å¤

## ğŸ” é—®é¢˜åˆ†æ

ç”¨æˆ·åé¦ˆï¼š**å·¥å…·æ¶ˆæ¯æ²¡æœ‰å»æ‰**ï¼Œå¹¶è´¨ç–‘ä¸ºä»€ä¹ˆå·¥å…·è°ƒç”¨è¦ä¸æ™®é€šæ¶ˆæ¯åˆ†å¼€å¤„ç†ã€‚

### æ ¹æœ¬é—®é¢˜
1. **åˆ†ç¦»çš„çŠ¶æ€ç®¡ç†** - æ¶ˆæ¯å­˜å‚¨åœ¨ `messages` æ•°ç»„ï¼Œå·¥å…·è°ƒç”¨å­˜å‚¨åœ¨ `toolCalls` æ•°ç»„
2. **åˆ é™¤é€»è¾‘ä¸å®Œæ•´** - `removeMessagesAfter` åªåˆ é™¤æ¶ˆæ¯ï¼Œå·¥å…·è°ƒç”¨åˆ é™¤é€»è¾‘æœ‰ç¼ºé™·
3. **æ—¶é—´æˆ³åŒ¹é…é—®é¢˜** - å·¥å…·è°ƒç”¨çš„æ—¶é—´æˆ³ä¸æ¶ˆæ¯æ—¶é—´æˆ³ä¸å®Œå…¨å¯¹åº”

## ğŸ¤” ä¸ºä»€ä¹ˆè¦åˆ†å¼€å¤„ç†ï¼Ÿ

### è®¾è®¡åŸå› åˆ†æ

#### 1. **å®æ—¶çŠ¶æ€ç®¡ç†éœ€æ±‚**
```typescript
// å·¥å…·è°ƒç”¨æœ‰å¤æ‚çš„çŠ¶æ€ç”Ÿå‘½å‘¨æœŸ
status: 'starting' | 'running' | 'completed' | 'failed'
```

#### 2. **UIæ¸²æŸ“éœ€æ±‚**
- å·¥å…·è°ƒç”¨éœ€è¦æ˜¾ç¤ºè¿›åº¦çŠ¶æ€
- æ¶ˆæ¯æ˜¯é™æ€å†…å®¹
- å·¥å…·è°ƒç”¨æœ‰åŠ¨æ€çš„è¿›åº¦æ›´æ–°

#### 3. **æ•°æ®æµä¸åŒ**
- **æ¶ˆæ¯æµ**ï¼šç”¨æˆ·è¾“å…¥ â†’ åŠ©æ‰‹å›å¤ â†’ å­˜å‚¨åˆ°æ•°æ®åº“
- **å·¥å…·è°ƒç”¨æµ**ï¼šåŠ©æ‰‹è§¦å‘ â†’ å®æ—¶çŠ¶æ€æ›´æ–° â†’ ç»“æœè¿”å› â†’ æœ€ç»ˆå­˜å‚¨

#### 4. **æ—¶é—´æˆ³ç®¡ç†**
```typescript
// å·¥å…·è°ƒç”¨æ—¶é—´æˆ³ = è§¦å‘æ¶ˆæ¯æ—¶é—´æˆ³ + 1
const toolCallTimestamp = baseTimestamp + 1;
```

### å½“å‰æ¶æ„çš„åˆç†æ€§

è™½ç„¶åˆ†ç¦»çœ‹èµ·æ¥å¤æ‚ï¼Œä½†æœ‰å…¶åˆç†æ€§ï¼š

1. **èŒè´£åˆ†ç¦»** - æ¶ˆæ¯è´Ÿè´£å†…å®¹ï¼Œå·¥å…·è°ƒç”¨è´Ÿè´£çŠ¶æ€
2. **æ€§èƒ½ä¼˜åŒ–** - é¿å…é¢‘ç¹æ›´æ–°å¤§å‹æ¶ˆæ¯æ•°ç»„
3. **æ‰©å±•æ€§** - å·¥å…·è°ƒç”¨å¯ä»¥æœ‰æ›´å¤æ‚çš„å…ƒæ•°æ®

## âœ… ä¿®å¤æ–¹æ¡ˆ

### é—®é¢˜æ ¹å› 
åŸæ¥çš„åˆ é™¤é€»è¾‘ï¼š
```typescript
// åŸºäºç²¾ç¡®æ—¶é—´æˆ³åŒ¹é… - å®¹æ˜“é—æ¼
const toolCallsToKeep = prev.toolCalls.filter(toolCall => 
  toolCall.timestamp && !removeTimestamps.includes(toolCall.timestamp)
);
```

### ä¿®å¤åçš„é€»è¾‘
```typescript
// åŸºäºæ—¶é—´èŒƒå›´åˆ é™¤ - æ›´å¯é 
const toolCallsToKeep = prev.toolCalls.filter(toolCall => {
  if (!toolCall.timestamp) {
    return true; // ä¿ç•™æ²¡æœ‰æ—¶é—´æˆ³çš„è°ƒç”¨
  }
  
  // åˆ é™¤åˆ†å‰ç‚¹ä¹‹åçš„æ‰€æœ‰å·¥å…·è°ƒç”¨
  return toolCall.timestamp <= forkPointTimestamp;
});
```

### å…³é”®æ”¹è¿›

1. **æ—¶é—´èŒƒå›´åˆ é™¤** - ä¸å†ä¾èµ–ç²¾ç¡®åŒ¹é…ï¼Œè€Œæ˜¯åˆ é™¤åˆ†å‰ç‚¹ä¹‹åçš„æ‰€æœ‰å·¥å…·è°ƒç”¨
2. **å®¹é”™å¤„ç†** - ä¿ç•™æ²¡æœ‰æ—¶é—´æˆ³çš„å·¥å…·è°ƒç”¨
3. **è¯¦ç»†æ—¥å¿—** - æ·»åŠ è°ƒè¯•ä¿¡æ¯ç¡®è®¤åˆ é™¤æ•ˆæœ

## ğŸ¯ ä¿®å¤æ•ˆæœ

### é¢„æœŸè¡Œä¸º
1. **åˆ†å‰æ—¶**ï¼š
   - åˆ é™¤åˆ†å‰ç‚¹ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯
   - åˆ é™¤åˆ†å‰ç‚¹ä¹‹åçš„æ‰€æœ‰å·¥å…·è°ƒç”¨
   - ä¿æŒåˆ†å‰ç‚¹åŠä¹‹å‰çš„çŠ¶æ€ä¸å˜

2. **å·¥å…·è°ƒç”¨åˆ é™¤**ï¼š
   - åŸºäºæ—¶é—´æˆ³èŒƒå›´åˆ é™¤ï¼Œè€Œä¸æ˜¯ç²¾ç¡®åŒ¹é…
   - ç¡®ä¿ä¸ä¼šé—æ¼ç›¸å…³çš„å·¥å…·è°ƒç”¨

### è°ƒè¯•ä¿¡æ¯
```
ğŸ—‘ï¸ åˆ é™¤åˆ†å‰ç‚¹åçš„æ¶ˆæ¯: 2 æ¡æ¶ˆæ¯, 1 ä¸ªå·¥å…·è°ƒç”¨
ğŸ“‹ åˆ é™¤çš„æ¶ˆæ¯: [...]
ğŸ”§ åˆ é™¤çš„å·¥å…·è°ƒç”¨: [...]
â° åˆ†å‰ç‚¹æ—¶é—´æˆ³: 1757317099556
```

## ğŸ”„ æœªæ¥ä¼˜åŒ–æ–¹å‘

### çŸ­æœŸä¼˜åŒ–
1. **éªŒè¯ä¿®å¤æ•ˆæœ** - ç¡®è®¤å·¥å…·è°ƒç”¨æ˜¯å¦æ­£ç¡®åˆ é™¤
2. **æ€§èƒ½ç›‘æ§** - ç›‘æ§åˆ é™¤æ“ä½œçš„æ€§èƒ½
3. **è¾¹ç•Œæƒ…å†µæµ‹è¯•** - æµ‹è¯•å„ç§å¤æ‚åœºæ™¯

### é•¿æœŸæ¶æ„ä¼˜åŒ–

#### æ–¹æ¡ˆ1ï¼šç»Ÿä¸€æ¶ˆæ¯æ¨¡å‹
```typescript
// æ‰©å±• Message æ¥å£æ”¯æŒå·¥å…·è°ƒç”¨
interface Message {
  // ... ç°æœ‰å­—æ®µ
  
  // å·¥å…·è°ƒç”¨ç›¸å…³å­—æ®µ
  toolName?: string;
  toolCallId?: string;
  status?: 'starting' | 'running' | 'completed' | 'failed';
  // ...
}
```

#### æ–¹æ¡ˆ2ï¼šäº‹ä»¶é©±åŠ¨æ¶æ„
```typescript
// ä½¿ç”¨äº‹ä»¶ç³»ç»Ÿç®¡ç†çŠ¶æ€å˜æ›´
interface StateEvent {
  type: 'message_added' | 'tool_call_started' | 'fork_created';
  payload: any;
  timestamp: number;
}
```

#### æ–¹æ¡ˆ3ï¼šå…³ç³»å‹çŠ¶æ€ç®¡ç†
```typescript
// å»ºç«‹æ¶ˆæ¯å’Œå·¥å…·è°ƒç”¨çš„æ˜ç¡®å…³ç³»
interface ToolCall {
  parentMessageId: string; // æ˜ç¡®å…³è”åˆ°è§¦å‘æ¶ˆæ¯
  // ...
}
```

## ğŸ“Š æ¶æ„æƒè¡¡

### å½“å‰åˆ†ç¦»æ¶æ„çš„ä¼˜ç¼ºç‚¹

#### ä¼˜ç‚¹ âœ…
- **èŒè´£æ¸…æ™°** - æ¶ˆæ¯å’Œå·¥å…·è°ƒç”¨å„å¸å…¶èŒ
- **æ€§èƒ½è¾ƒå¥½** - é¿å…å¤§æ•°ç»„çš„é¢‘ç¹æ›´æ–°
- **æ‰©å±•æ€§å¼º** - å·¥å…·è°ƒç”¨å¯ä»¥æœ‰å¤æ‚çš„çŠ¶æ€ç®¡ç†

#### ç¼ºç‚¹ âŒ
- **çŠ¶æ€åŒæ­¥å¤æ‚** - éœ€è¦æ‰‹åŠ¨ç»´æŠ¤ä¸¤ä¸ªæ•°ç»„çš„ä¸€è‡´æ€§
- **åˆ é™¤é€»è¾‘å¤æ‚** - éœ€è¦åŒæ—¶å¤„ç†ä¸¤ä¸ªæ•°æ®æº
- **ç†è§£æˆæœ¬é«˜** - å¼€å‘è€…éœ€è¦ç†è§£åˆ†ç¦»çš„è®¾è®¡

### ç»Ÿä¸€æ¶æ„çš„ä¼˜ç¼ºç‚¹

#### ä¼˜ç‚¹ âœ…
- **æ¦‚å¿µç®€å•** - æ‰€æœ‰å†…å®¹éƒ½æ˜¯æ¶ˆæ¯
- **çŠ¶æ€ä¸€è‡´** - å•ä¸€æ•°æ®æºï¼Œä¸ä¼šå‡ºç°ä¸ä¸€è‡´
- **åˆ é™¤ç®€å•** - åªéœ€è¦æ“ä½œä¸€ä¸ªæ•°ç»„

#### ç¼ºç‚¹ âŒ
- **æ€§èƒ½é—®é¢˜** - å¤§æ•°ç»„çš„é¢‘ç¹æ›´æ–°
- **ç±»å‹å¤æ‚** - éœ€è¦å¤æ‚çš„è”åˆç±»å‹
- **æ¸²æŸ“å¤æ‚** - UIéœ€è¦å¤„ç†å¤šç§æ¶ˆæ¯ç±»å‹

## ğŸ‰ ç»“è®º

### å½“å‰ä¿®å¤
é€šè¿‡æ”¹è¿›åˆ é™¤é€»è¾‘ï¼Œæˆ‘ä»¬è§£å†³äº†å·¥å…·è°ƒç”¨æ²¡æœ‰è¢«æ­£ç¡®åˆ é™¤çš„é—®é¢˜ï¼š
- ä½¿ç”¨æ—¶é—´èŒƒå›´åˆ é™¤è€Œä¸æ˜¯ç²¾ç¡®åŒ¹é…
- æ·»åŠ è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
- æé«˜åˆ é™¤æ“ä½œçš„å¯é æ€§

### æ¶æ„é€‰æ‹©
è™½ç„¶åˆ†ç¦»æ¶æ„æœ‰å…¶å¤æ‚æ€§ï¼Œä½†è€ƒè™‘åˆ°ï¼š
1. **ç°æœ‰ä»£ç é‡** - é‡æ„æˆæœ¬å¾ˆé«˜
2. **æ€§èƒ½è¦æ±‚** - å®æ—¶å·¥å…·è°ƒç”¨çŠ¶æ€æ›´æ–°
3. **æ‰©å±•éœ€æ±‚** - æœªæ¥å¯èƒ½æœ‰æ›´å¤æ‚çš„å·¥å…·è°ƒç”¨

**å»ºè®®ä¿æŒå½“å‰æ¶æ„**ï¼Œä½†é€šè¿‡ä»¥ä¸‹æ–¹å¼æ”¹è¿›ï¼š
1. **å®Œå–„åˆ é™¤é€»è¾‘** - ç¡®ä¿çŠ¶æ€åŒæ­¥çš„å¯é æ€§
2. **æ·»åŠ çŠ¶æ€éªŒè¯** - å®šæœŸæ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
3. **æ”¹è¿›è°ƒè¯•å·¥å…·** - æä¾›æ›´å¥½çš„çŠ¶æ€å¯è§†åŒ–

è¿™æ ·æ—¢ä¿æŒäº†æ¶æ„çš„ä¼˜åŠ¿ï¼Œåˆè§£å†³äº†å½“å‰çš„é—®é¢˜ã€‚
