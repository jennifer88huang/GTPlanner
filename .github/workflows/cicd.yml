name: CI/CD Pipeline


on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

env:
  IMAGE_NAME: gtplanner
  REGISTRY: ghcr.io
  NAMESPACE: default
  DEPLOYMENT_NAME: gtplanner

jobs:

  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: å®‰è£…uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        
    - name: å®‰è£…ä¾èµ–
      run: |
        uv venv
        source .venv/bin/activate
        uv pip install -e .
        uv pip install --group dev
        
    - name: ä»£ç è´¨é‡æ£€æŸ¥
      run: |
        source .venv/bin/activate
        # ç¼–è¯‘æ£€æŸ¥ä¸»è¦ Python æ–‡ä»¶
        echo "æ£€æŸ¥ä¸»è¦ Python æ–‡ä»¶è¯­æ³•..."
        python -m py_compile gtplanner.py
        python -m py_compile fastapi_main.py

        # æ£€æŸ¥æ ¸å¿ƒæ¨¡å—
        echo "æ£€æŸ¥æ ¸å¿ƒæ¨¡å—..."
        python -c "import agent; print('agent æ¨¡å—å¯¼å…¥æˆåŠŸ')" || echo "agent æ¨¡å—å¯¼å…¥å¤±è´¥"
        python -c "import utils; print('utils æ¨¡å—å¯¼å…¥æˆåŠŸ')" || echo "utils æ¨¡å—å¯¼å…¥å¤±è´¥"

        # æ£€æŸ¥å…³é”®æ–‡ä»¶è¯­æ³•
        echo "æ£€æŸ¥å…³é”®æ–‡ä»¶è¯­æ³•..."
        find agent -name "*.py" -exec python -m py_compile {} \; || echo "éƒ¨åˆ† agent æ–‡ä»¶ç¼–è¯‘å¤±è´¥"
        find utils -name "*.py" -exec python -m py_compile {} \; || echo "éƒ¨åˆ† utils æ–‡ä»¶ç¼–è¯‘å¤±è´¥"
        
    - name: è¿è¡Œæµ‹è¯•
      run: |
        source .venv/bin/activate
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨æµ‹è¯•ç›®å½•
        if [ -d "tests" ]; then
          echo "è¿è¡Œæµ‹è¯•å¥—ä»¶..."
          python -m pytest tests/ -v || echo "éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"
        else
          echo "æœªæ‰¾åˆ°æµ‹è¯•ç›®å½•ï¼Œè·³è¿‡æµ‹è¯•"
        fi

        # è¿è¡ŒåŸºæœ¬åŠŸèƒ½æµ‹è¯•
        echo "è¿è¡ŒåŸºæœ¬åŠŸèƒ½æµ‹è¯•..."
        python -c "
        import sys
        try:
            import gtplanner
            print('âœ… gtplanner æ¨¡å—å¯¼å…¥æˆåŠŸ')
        except Exception as e:
            print(f'âŒ gtplanner æ¨¡å—å¯¼å…¥å¤±è´¥: {e}')
            sys.exit(1)

        try:
            import fastapi_main
            print('âœ… fastapi_main æ¨¡å—å¯¼å…¥æˆåŠŸ')
        except Exception as e:
            print(f'âŒ fastapi_main æ¨¡å—å¯¼å…¥å¤±è´¥: {e}')
            sys.exit(1)

        print('âœ… æ‰€æœ‰åŸºæœ¬åŠŸèƒ½æµ‹è¯•é€šè¿‡')
        "


  docker-build-push:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')  
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
    outputs:
      image-tag: ${{ steps.image-info.outputs.image-tag }}
      full-image-name: ${{ steps.image-info.outputs.full-image-name }}
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ç™»å½•GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ç”Ÿæˆé•œåƒæ ‡ç­¾å’Œå…ƒæ•°æ®
      id: image-info
      run: |
        # ä½¿ç”¨tagä½œä¸ºé•œåƒæ ‡ç­¾
        TAG_NAME=${GITHUB_REF#refs/tags/}
        SHORT_SHA=${GITHUB_SHA::7}
        IMAGE_TAG="${TAG_NAME}-${SHORT_SHA}"
        
        # ä½¿ç”¨ä»“åº“ownerä½œä¸ºç»„ç»‡åï¼Œè½¬æ¢ä¸ºå°å†™ï¼ˆDockerè¦æ±‚ï¼‰
        REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
        FULL_IMAGE_NAME="${{ env.REGISTRY }}/${REPO_OWNER}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
        LATEST_IMAGE_NAME="${{ env.REGISTRY }}/${REPO_OWNER}/${{ env.IMAGE_NAME }}:latest"
        
        echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
        echo "full-image-name=${FULL_IMAGE_NAME}" >> $GITHUB_OUTPUT
        echo "latest-image-name=${LATEST_IMAGE_NAME}" >> $GITHUB_OUTPUT
        
    - name: æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ steps.image-info.outputs.full-image-name }}
          ${{ steps.image-info.outputs.latest-image-name }}
        cache-from: type=gha
        cache-to: type=gha,mode=max


  docker-build-push-test:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
    outputs:
      image-tag: ${{ steps.image-info.outputs.image-tag }}
      full-image-name: ${{ steps.image-info.outputs.full-image-name }}

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½•GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ç”Ÿæˆæµ‹è¯•é•œåƒæ ‡ç­¾å’Œå…ƒæ•°æ®
      id: image-info
      run: |
        # ä½¿ç”¨åˆ†æ”¯åå’Œcommit SHAä½œä¸ºæµ‹è¯•é•œåƒæ ‡ç­¾
        BRANCH_NAME=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}
        BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g')
        SHORT_SHA=${GITHUB_SHA::7}
        IMAGE_TAG="test-${BRANCH_NAME}-${SHORT_SHA}"

        # ä½¿ç”¨ä»“åº“ownerä½œä¸ºç»„ç»‡åï¼Œè½¬æ¢ä¸ºå°å†™ï¼ˆDockerè¦æ±‚ï¼‰
        REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
        FULL_IMAGE_NAME="${{ env.REGISTRY }}/${REPO_OWNER}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"

        echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
        echo "full-image-name=${FULL_IMAGE_NAME}" >> $GITHUB_OUTPUT

    - name: æ„å»ºå¹¶æ¨é€æµ‹è¯•Dockeré•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.image-info.outputs.full-image-name }}
        cache-from: type=gha
        cache-to: type=gha,mode=max


  deploy-to-kubernetes:
    needs: docker-build-push
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')  
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      
    - name: Deploy to Kubernetes
      env:
        K8S_TOKEN: ${{ secrets.K8S_TOKEN }}
        VERSION: ${{ github.sha }}
        K8S_API_URL: ${{ secrets.K8S_API_URL }}
        DEPLOYMENT_NAME: ${{ secrets.DEPLOYMENT_NAME }}
        NAMESPACE: ${{ secrets.NAMESPACE }}
      run: |
        # Prepare lowercase repository name for Docker compliance
        REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
        CI_REGISTRY_IMAGE="${{ env.REGISTRY }}/${REPO_OWNER_LOWER}/gtplanner"

        # ä½¿ç”¨tagä¿¡æ¯
        TAG_NAME=${GITHUB_REF#refs/tags/}
        IMAGE_TAG="${{ needs.docker-build-push.outputs.full-image-name }}"
        
        echo "Deploying image: $IMAGE_TAG"
        echo "Tag: $TAG_NAME"
        
        # Update the deployment using the provided API
        curl -X PATCH \
          -H "content-type: application/strategic-merge-patch+json" \
          -H "Authorization: $K8S_TOKEN" \
          -d "{\"spec\":{\"template\":{\"spec\":{\"containers\":[{\"name\":\"gtplanner\",\"image\":\"$IMAGE_TAG\"}]}}}}" \
          "$K8S_API_URL/apis/apps/v1/namespaces/$NAMESPACE/deployments/$DEPLOYMENT_NAME"
        
        echo "Deployment updated successfully"

    - name: Verify deployment
      env:
        K8S_TOKEN: ${{ secrets.K8S_TOKEN }}
        K8S_API_URL: ${{ secrets.K8S_API_URL }}
        DEPLOYMENT_NAME: ${{ secrets.DEPLOYMENT_NAME }}
        NAMESPACE: ${{ secrets.NAMESPACE }}
      run: |
        # Wait for rollout to complete
        echo "Waiting for deployment to complete..."
        
        # Check deployment status
        for i in {1..30}; do
          STATUS=$(curl -s -H "Authorization:  $K8S_TOKEN" \
            "$K8S_API_URL/apis/apps/v1/namespaces/$NAMESPACE/deployments/$DEPLOYMENT_NAME" | \
            jq -r '.status.conditions[] | select(.type=="Progressing") | .status')
          
          if [ "$STATUS" = "True" ]; then
            echo "Deployment completed successfully"
            break
          fi
          
          echo "Waiting for deployment... ($i/30)"
          sleep 10
        done
        
    - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
        echo "æ ‡ç­¾: $TAG_NAME"
        echo "é•œåƒ: ${{ needs.docker-build-push.outputs.full-image-name }}"
        echo "å‘½åç©ºé—´: ${{ env.NAMESPACE }}"
        echo "Deployment: ${{ env.DEPLOYMENT_NAME }}"


  deploy-to-test-kubernetes:
    needs: docker-build-push-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: Deploy to Test Kubernetes
      env:
        K8S_TEST_TOKEN: ${{ secrets.K8S_TEST_TOKEN }}
        VERSION: ${{ github.sha }}
      run: |
        # ä½¿ç”¨æµ‹è¯•ç¯å¢ƒçš„é•œåƒ
        IMAGE_TAG="${{ needs.docker-build-push-test.outputs.full-image-name }}"

        echo "Deploying test image: $IMAGE_TAG"
        echo "Branch: ${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
        echo "Commit: ${GITHUB_SHA::7}"

        # ä½¿ç”¨æ‚¨æä¾›çš„æµ‹è¯•ç¯å¢ƒK8séƒ¨ç½²è„šæœ¬
        curl -X PATCH \
          -H "content-type: application/strategic-merge-patch+json" \
          -H "Authorization:Bearer $K8S_TEST_TOKEN" \
          -d "{\"spec\":{\"template\":{\"spec\":{\"containers\":[{\"name\":\"gt-planner-backend-test\",\"image\":\"$IMAGE_TAG\"}]}}}}" \
          "http://kuboard.sensedeal.wiki/k8s-api/apis/apps/v1/namespaces/agent-build/deployments/gt-planner-backend-test"

        echo "Test deployment updated successfully"

    - name: Verify test deployment
      env:
        K8S_TEST_TOKEN: ${{ secrets.K8S_TEST_TOKEN }}
      run: |
        # ç­‰å¾…æµ‹è¯•éƒ¨ç½²å®Œæˆ
        echo "Waiting for test deployment to complete..."

        # æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
        for i in {1..30}; do
          STATUS=$(curl -s -H "Authorization: Bearer $K8S_TEST_TOKEN" \
            "http://kuboard.sensedeal.wiki/k8s-api/apis/apps/v1/namespaces/agent-build/deployments/gt-planner-backend-test" | \
            jq -r '.status.conditions[] | select(.type=="Progressing") | .status' 2>/dev/null || echo "Unknown")

          if [ "$STATUS" = "True" ]; then
            echo "Test deployment completed successfully"
            break
          fi

          echo "Waiting for test deployment... ($i/30)"
          sleep 10
        done

    - name: æµ‹è¯•éƒ¨ç½²æˆåŠŸé€šçŸ¥
      run: |
        BRANCH_NAME=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}
        echo "ğŸ§ª æµ‹è¯•ç¯å¢ƒéƒ¨ç½²æˆåŠŸ!"
        echo "åˆ†æ”¯: $BRANCH_NAME"
        echo "é•œåƒ: ${{ needs.docker-build-push-test.outputs.full-image-name }}"
        echo "å‘½åç©ºé—´: agent-build"
        echo "Deployment: gt-planner-backend-test"