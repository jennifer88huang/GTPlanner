# Function Callingå·¥å…·ç³»ç»Ÿå®ç°æ€»ç»“

## ğŸ‰ é‡å¤§æˆå°±

æˆ‘ä»¬å·²ç»æˆåŠŸå®Œæˆäº†ReActç³»ç»Ÿä¼˜åŒ–è®¡åˆ’çš„å‰ä¸¤ä¸ªé˜¶æ®µï¼Œå»ºç«‹äº†å®Œæ•´çš„Function Callingå·¥å…·ç³»ç»ŸåŸºç¡€è®¾æ–½ï¼

## âœ… å·²å®Œæˆçš„é˜¶æ®µ

### é˜¶æ®µ1ï¼šOpenAI SDKè¿ç§»åŸºç¡€è®¾æ–½ âœ…

#### 1.1 ç°æœ‰LLMè°ƒç”¨æ¶æ„åˆ†æ âœ…
- **æ–‡ä»¶**: `CURRENT_LLM_ARCHITECTURE_ANALYSIS.md`
- **æˆæœ**: æ·±å…¥åˆ†æäº†ç°æœ‰çš„aiohttpå®ç°ï¼Œè¯†åˆ«äº†è¿ç§»åˆ°OpenAI SDKçš„ä¼˜åŠ¿å’ŒæŒ‘æˆ˜

#### 1.2 OpenAI SDKé…ç½®ç³»ç»Ÿ âœ…
- **æ–‡ä»¶**: `config/openai_config.py`
- **åŠŸèƒ½**: 
  - ç»Ÿä¸€çš„é…ç½®ç®¡ç†ï¼ˆOpenAIConfigç±»ï¼‰
  - å¤šç¯å¢ƒæ”¯æŒå’Œå‚æ•°éªŒè¯
  - ä¸ç°æœ‰Dynaconfç³»ç»Ÿçš„å…¼å®¹æ€§
  - Function Callingç›¸å…³é…ç½®

#### 1.3 OpenAI SDKå°è£…å±‚ âœ…
- **æ–‡ä»¶**: `utils/openai_client.py`
- **åŠŸèƒ½**:
  - å®Œæ•´çš„OpenAI SDKå°è£…ï¼ˆOpenAIClientç±»ï¼‰
  - åŒæ­¥å’Œå¼‚æ­¥è°ƒç”¨æ”¯æŒ
  - Function CallingåŸç”Ÿæ”¯æŒ
  - å‘åå…¼å®¹çš„APIæ¥å£
  - æ€§èƒ½ç»Ÿè®¡å’Œç›‘æ§

#### 1.4 æµå¼è¾“å‡ºæ”¯æŒ âœ…
- **æ–‡ä»¶**: `utils/openai_stream_adapter.py`
- **åŠŸèƒ½**:
  - OpenAIæµå¼è¾“å‡ºé€‚é…å™¨
  - ä¸JSONStreamParserçš„å…¼å®¹æ€§
  - Function Callingæµå¼å¤„ç†
  - ä¼ ç»ŸAPIå…¼å®¹å±‚

#### 1.5 é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶ âœ…
- **æ–‡ä»¶**: `utils/openai_client.py` (RetryManagerç±»)
- **åŠŸèƒ½**:
  - æ™ºèƒ½é‡è¯•æœºåˆ¶ï¼ˆæŒ‡æ•°é€€é¿ + éšæœºæŠ–åŠ¨ï¼‰
  - OpenAIç‰¹å®šé”™è¯¯å¤„ç†
  - è¶…æ—¶å’Œç½‘ç»œé”™è¯¯ç®¡ç†
  - å®Œæ•´çš„æµ‹è¯•è¦†ç›–

### é˜¶æ®µ2ï¼šFunction Callingå·¥å…·è®¾è®¡ä¸å®ç° âœ…

#### 2.1 Function Callingå·¥å…·æ¶æ„ âœ…
- **æ–‡ä»¶**: `agent/tools/base_tool.py`
- **æ ¸å¿ƒç»„ä»¶**:
  - `BaseTool` - å·¥å…·åŸºç±»
  - `AsyncTool` - å¼‚æ­¥å·¥å…·åŸºç±»
  - `ToolParameter` - å‚æ•°å®šä¹‰ç³»ç»Ÿ
  - `ToolResult` - ç»“æœå°è£…
  - `ToolRegistry` - å·¥å…·æ³¨å†Œè¡¨
  - `ToolExecutionContext` - æ‰§è¡Œä¸Šä¸‹æ–‡

#### 2.2 å­Agentå·¥å…·æ¥å£å®šä¹‰ âœ…
- **éœ€æ±‚åˆ†æå·¥å…·**: `agent/tools/requirements_analysis_tool.py`
  - æ”¯æŒå¤šç§åˆ†ææ·±åº¦å’Œä¸šåŠ¡é¢†åŸŸ
  - æ™ºèƒ½éœ€æ±‚å¢å¼ºå’Œä¸Šä¸‹æ–‡æ„å»º
  - ä¸ç°æœ‰RequirementsAnalysisFlowé›†æˆ

- **çŸ­æœŸè§„åˆ’å·¥å…·**: `agent/tools/short_planning_tool.py`
  - åŸºäºéœ€æ±‚ç”Ÿæˆå¯æ‰§è¡Œè®¡åˆ’
  - æ”¯æŒå¤šç§å¼€å‘æ–¹æ³•è®ºå’Œä¼˜å…ˆçº§ç­–ç•¥
  - è‡ªåŠ¨ç”Ÿæˆè§„åˆ’æ‘˜è¦å’Œèµ„æºè¯„ä¼°

- **æŠ€æœ¯è°ƒç ”å·¥å…·**: `agent/tools/research_tool.py`
  - å¤šä¸»é¢˜å¹¶è¡Œè°ƒç ”
  - çµæ´»çš„å…³æ³¨é¢†åŸŸå’Œçº¦æŸæ¡ä»¶
  - å¤šç§è¾“å‡ºæ ¼å¼ï¼ˆæ‘˜è¦ã€è¯¦ç»†æŠ¥å‘Šã€å¯¹æ¯”è¡¨æ ¼ï¼‰

- **æ¶æ„è®¾è®¡å·¥å…·**: `agent/tools/architecture_design_tool.py`
  - ç»¼åˆå‰æœŸç»“æœç”Ÿæˆæ¶æ„è®¾è®¡
  - æ”¯æŒå¤šç§æ¶æ„ç±»å‹å’Œéƒ¨ç½²ç¯å¢ƒ
  - æ€§èƒ½ã€å®‰å…¨ã€å¯æ‰©å±•æ€§å…¨é¢è€ƒè™‘

#### 2.3 å·¥å…·æ³¨å†Œç³»ç»Ÿ âœ…
- **æ–‡ä»¶**: `agent/tools/base_tool.py` (ToolRegistryç±»)
- **åŠŸèƒ½**:
  - åŠ¨æ€å·¥å…·æ³¨å†Œå’Œå‘ç°
  - åˆ†ç±»ç®¡ç†å’Œæ‰¹é‡æ“ä½œ
  - Function Callingå®šä¹‰è‡ªåŠ¨ç”Ÿæˆ
  - å…¨å±€æ³¨å†Œè¡¨å•ä¾‹æ¨¡å¼

#### 2.4 å·¥å…·è°ƒç”¨æ‰§è¡Œå™¨ âœ…
- **æ–‡ä»¶**: `agent/tools/tool_executor.py`
- **åŠŸèƒ½**:
  - å¼‚æ­¥å¹¶å‘æ‰§è¡Œ
  - å‚æ•°éªŒè¯å’Œè¶…æ—¶æ§åˆ¶
  - æ‰§è¡Œç›‘æ§å’Œç»Ÿè®¡
  - å›è°ƒæœºåˆ¶å’Œé”™è¯¯å¤„ç†

#### 2.5 å·¥å…·ç»“æœå¤„ç† âœ…
- **æ–‡ä»¶**: `agent/tools/result_processor.py`
- **åŠŸèƒ½**:
  - å¤šç§æ ¼å¼åŒ–é€‰é¡¹ï¼ˆJSONã€Markdownã€æ‘˜è¦ç­‰ï¼‰
  - ç»“æœéªŒè¯å’Œè½¬æ¢
  - å¤šç»“æœèšåˆ
  - å…ƒæ•°æ®ç”Ÿæˆ

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„äº®ç‚¹

### 1. å®Œæ•´çš„å¼‚æ­¥æ¶æ„
```python
# æ‰€æœ‰ç»„ä»¶éƒ½æ”¯æŒå¼‚æ­¥æ“ä½œ
async def execute_tool(tool_name: str, arguments: Dict) -> ToolResult
async def chat_completion_stream_async(messages: List[Dict]) -> AsyncIterator[str]
```

### 2. ç±»å‹å®‰å…¨çš„å‚æ•°ç³»ç»Ÿ
```python
# å¼ºç±»å‹å‚æ•°å®šä¹‰
ToolParameter(
    name="user_input",
    type="string", 
    description="ç”¨æˆ·éœ€æ±‚æè¿°",
    required=True
)
```

### 3. æ™ºèƒ½é”™è¯¯å¤„ç†
```python
# å¤šå±‚é”™è¯¯å¤„ç†å’Œé‡è¯•
RetryManager(max_retries=3, base_delay=1.0)
OpenAIRateLimitError, OpenAITimeoutError, OpenAIRetryableError
```

### 4. çµæ´»çš„ç»“æœæ ¼å¼åŒ–
```python
# å¤šç§è¾“å‡ºæ ¼å¼
ResultFormat.JSON, ResultFormat.MARKDOWN, ResultFormat.SUMMARY
```

## ğŸ“Š æµ‹è¯•è¦†ç›–

### å®Œæ•´çš„æµ‹è¯•å¥—ä»¶
- `tests/test_openai_error_handling.py` - OpenAIé”™è¯¯å¤„ç†æµ‹è¯•
- `tests/test_tool_registration.py` - å·¥å…·æ³¨å†Œç³»ç»Ÿæµ‹è¯•  
- `tests/test_tool_executor.py` - å·¥å…·æ‰§è¡Œå™¨æµ‹è¯•

### æµ‹è¯•è¦†ç›–èŒƒå›´
- âœ… å•å…ƒæµ‹è¯•ï¼šæ‰€æœ‰æ ¸å¿ƒç»„ä»¶
- âœ… é›†æˆæµ‹è¯•ï¼šå·¥å…·é“¾åä½œ
- âœ… é”™è¯¯åœºæ™¯ï¼šå¼‚å¸¸å¤„ç†å’Œæ¢å¤
- âœ… æ€§èƒ½æµ‹è¯•ï¼šå¹¶å‘å’Œè¶…æ—¶

## ğŸ”§ é…ç½®ç¤ºä¾‹

### OpenAIé…ç½®
```toml
[openai]
enabled = true
api_key = "your-api-key"
base_url = "https://api.openai.com/v1"
model = "gpt-4"
function_calling_enabled = true
max_retries = 3
timeout = 120.0
```

### å·¥å…·ä½¿ç”¨ç¤ºä¾‹
```python
# æ³¨å†Œå·¥å…·
from agent.tools import requirements_analysis_tool
register_tool(requirements_analysis_tool, "agent")

# æ‰§è¡Œå·¥å…·
executor = get_tool_executor()
response = await executor.execute_tool(
    "requirements_analysis",
    {"user_input": "æˆ‘æƒ³å¼€å‘ä¸€ä¸ªç”µå•†ç½‘ç«™"}
)
```

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

### é˜¶æ®µ3ï¼šReActä¸»æ§åˆ¶å™¨é‡æ„
- [ ] é‡æ„ReActOrchestratorNodeä»¥æ”¯æŒFunction Calling
- [ ] å®ç°å·¥å…·ä¸å¯¹è¯çš„æ··åˆæ¨¡å¼
- [ ] æµå¼å·¥å…·è°ƒç”¨å¤„ç†
- [ ] é”™è¯¯å¤„ç†å’Œé‡è¯•ä¼˜åŒ–

### é˜¶æ®µ4ï¼šæµå¼è¾“å‡ºä¸Function Callingé›†æˆ
- [ ] JSONStreamParseræ‰©å±•
- [ ] å·¥å…·è°ƒç”¨çš„æµå¼æ˜¾ç¤º
- [ ] CLIä½“éªŒä¼˜åŒ–

### é˜¶æ®µ5ï¼šæµ‹è¯•éªŒè¯ä¸æ€§èƒ½ä¼˜åŒ–
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] ç”¨æˆ·ä½“éªŒéªŒè¯

## ğŸ’¡ åˆ›æ–°ç‰¹æ€§

### 1. å·¥å…·é“¾éªŒè¯
```python
# è‡ªåŠ¨éªŒè¯å·¥å…·è°ƒç”¨é“¾çš„åˆç†æ€§
validate_tool_chain(["requirements_analysis", "short_planning", "architecture_design"])
```

### 2. ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„å·¥å…·æ‰§è¡Œ
```python
# å·¥å…·å¯ä»¥è®¿é—®å…±äº«çŠ¶æ€å’Œæ‰§è¡Œä¸Šä¸‹æ–‡
ToolExecutionContext(shared_state={"previous_results": data})
```

### 3. æ™ºèƒ½å‚æ•°å¢å¼º
```python
# å·¥å…·è‡ªåŠ¨å¢å¼ºç”¨æˆ·è¾“å…¥
enhanced_input = self._build_enhanced_input(
    user_input, domain, target_users, business_goals
)
```

## ğŸ¯ æˆåŠŸæŒ‡æ ‡

### åŠŸèƒ½æŒ‡æ ‡ âœ…
- [x] æ‰€æœ‰å­AgentæˆåŠŸè½¬æ¢ä¸ºFunction Callingå·¥å…·
- [x] å®Œæ•´çš„å·¥å…·æ³¨å†Œå’Œå‘ç°ç³»ç»Ÿ
- [x] å¼‚æ­¥æ‰§è¡Œå’Œé”™è¯¯å¤„ç†æœºåˆ¶
- [x] å¤šç§ç»“æœæ ¼å¼åŒ–é€‰é¡¹

### æ¶æ„æŒ‡æ ‡ âœ…
- [x] ç±»å‹å®‰å…¨çš„å‚æ•°ç³»ç»Ÿ
- [x] å¯æ‰©å±•çš„å·¥å…·æ¶æ„
- [x] å®Œæ•´çš„æµ‹è¯•è¦†ç›–
- [x] å‘åå…¼å®¹æ€§ä¿è¯

### æ€§èƒ½æŒ‡æ ‡ âœ…
- [x] å¼‚æ­¥å¹¶å‘æ‰§è¡Œ
- [x] æ™ºèƒ½é‡è¯•å’Œè¶…æ—¶æ§åˆ¶
- [x] æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡
- [x] å†…å­˜å’Œèµ„æºä¼˜åŒ–

## ğŸ† æ€»ç»“

æˆ‘ä»¬å·²ç»æˆåŠŸå»ºç«‹äº†ä¸€ä¸ª**ä¸–ç•Œçº§çš„Function Callingå·¥å…·ç³»ç»Ÿ**ï¼Œå…·å¤‡ï¼š

1. **å®Œæ•´çš„å¼‚æ­¥æ¶æ„** - ä»åº•å±‚åˆ°åº”ç”¨å±‚å…¨é¢å¼‚æ­¥åŒ–
2. **ç±»å‹å®‰å…¨çš„è®¾è®¡** - å¼ºç±»å‹å‚æ•°å®šä¹‰å’ŒéªŒè¯
3. **æ™ºèƒ½é”™è¯¯å¤„ç†** - å¤šå±‚é”™è¯¯å¤„ç†å’Œè‡ªåŠ¨é‡è¯•
4. **çµæ´»çš„æ‰©å±•æ€§** - æ˜“äºæ·»åŠ æ–°å·¥å…·å’ŒåŠŸèƒ½
5. **å®Œå–„çš„æµ‹è¯•è¦†ç›–** - ç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§å’Œå¯é æ€§

è¿™ä¸ºåç»­çš„ReActä¸»æ§åˆ¶å™¨é‡æ„å¥ å®šäº†åšå®çš„åŸºç¡€ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥å®ç°çœŸæ­£çš„**å·¥å…·ä¸å¯¹è¯æ— ç¼åˆ‡æ¢**çš„æ™ºèƒ½Agentç³»ç»Ÿï¼ğŸš€
